<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/iron-list/iron-list.html">
<link rel="import" href="../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../bower_components/vaadin-upload/vaadin-upload.html">
<link rel="import" href="./km-ajax.html">

<dom-module id="km-admin-gallery">
    <template>
        <style>
            :host{
                display: block;
                padding: 10px;
            }
            #uploadList {
                width: 100%;
                height: 100%;
            }
            .upload-img {
                width: 200px;
                height: 200px;
            }
            .upload    {
                /*margin: 10px;*/
                width:200px;
                height:200px;
                box-shadow:inset 1px 1px 40px 0 rgba(0,0,0,.45);
                border-bottom:2px solid #fff;
                border-right:2px solid #fff;
                margin:5% auto 0 auto;
                /*background:url(http://ianfarb.com/wp-content/uploads/2013/10/nicholas-hodag.jpg);*/
                background-size: 100% 100% !important;;
                border-radius:5px;
                overflow:hidden;
            }
            .overlay    {
                background:rgba(0,0,0,.75);
                width:200px;
                height:200px;
                text-align:center;
                opacity:0;
                -webkit-transition: opacity .25s ease;
                -moz-transition: opacity .25s ease;
            }

            .upload:hover .overlay {
                opacity:1;
            }
        </style>
        <km-ajax id="ajax"></km-ajax>
        <div>
            <paper-button on-click="_onUploadClick" raised="1">Upload</paper-button>
            <br><br>
            <iron-list id="uploadList" items="[[uploads]]" as="item" grid>
                <template>
                    <div tabindex$="[[tabIndex]]">
                        <div class="upload" style="background: url(/gallery/upload/?k=[[item.BlobKey]])">
                        </div>
                        <paper-button hidden$="[[!selectable]]">Select</paper-button>
                        <paper-button data-args="[[item.BlobKey]]" class="remove-button" on-click="_uploadRemove">Remove</paper-button>
                    </div>
                </template>
            </iron-list>
            <paper-dialog id="modal">
                <h2>Upload</h2>
                <p>
                    <vaadin-upload id="uploader" on-upload-response="_onUploadResponse" target="[[uploadUrl]]" method="POST"></vaadin-upload>
                </p>
            </paper-dialog>
        </div>
    </template>
    <script>
        (function () {
            Polymer({
                is: 'km-admin-gallery',
                properties: {
                    uploadUrl: {
                        type: String,
                        value: ""
                    },
                    uploads: {
                        type: Array,
                        value: function(){
                            return [];
                        }
                    },
                    selectable:{
                        type: Boolean,
                        value: false
                    }
                },
                _uploadRemove: function(evt){
                    var self = this;
                    var key = evt.model.get('item.BlobKey');
                    var index = evt.model.get('index');
                    console.log("Removing", index, key);
                    var req = self.$.ajax.removeGalleryUploads(key);
                    req.completes.then(function(){
                        console.log("File removed successfully");
                        self.splice("uploads", index, 1);
                    }, function(){
                        console.log(req.response);
                    });
                },
                _onUploadResponse: function(event){
                    console.log('upload xhr after server response: ', event.detail.xhr);
                    var xhr = event.detail.xhr;
                    var response;
                    try{
                        response = JSON.parse(xhr.responseText)
                    }catch (e){
                        response = "";
                    }

                    if(xhr.status === 200){
                        for(var i = 0 ; i < response.length; i++){
                            var upload = response[i];
                            this.unshift('uploads', upload);
                        }
                    }else {
                        console.log(response);
                        event.detail.file.error = response;
                    }
                    this.$.modal.close();
                },
                _onUploadClick: function(){
                    var self = this;
                    self.$.uploader.files = [];
                    var req = self.$.ajax.getGalleryUploadUrl();
                    req.completes.then(function(){
                        var url = req.response;
                        console.log("Upload url:", url);
                        self.uploadUrl = url;
                        self.$.modal.open();
                    }, function(){
                        console.log(req.response);
                    });
                },
                _fetchUploads: function(){
                    var self = this;
                    var req = self.$.ajax.getGalleryUploads();
                    req.completes.then(function(){
                        var uploads = req.response;
                        console.log("Gallery Uploads:", uploads);
                        for(var i = 0 ; i < uploads.length ; i++){
                            var upload = uploads[i];
                            self.push("uploads", upload);
                        }
                        setTimeout(function(){
                            self.$.uploadList.notifyResize();
                        });
                    }, function(){
                        console.log(req.response);
                    })
                },
                ready: function(){
                    this._fetchUploads();
                }
            });
        })();
    </script>
</dom-module>