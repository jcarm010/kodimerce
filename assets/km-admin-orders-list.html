<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/vaadin-grid/vaadin-grid.html">
<link rel="import" href="../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/paper-input/paper-input.html">
<link rel="import" href="../bower_components/paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="../bower_components/paper-menu/paper-menu.html">
<link rel="import" href="../bower_components/paper-item/paper-item.html">
<link rel="import" href="../bower_components/paper-toggle-button/paper-toggle-button.html">

<link rel="import" href="./km-ajax.html">

<dom-module id="km-admin-orders-list">
    <template>
        <style>
            :host{
                display: block;
            }
            td.label{
                font-weight: bold;
            }
            td.value{
                width: 300px;
                font-weight: bold;
            }
            td.value>*{
                width:100%;
            }
            #order-details td {
                padding-left: 5px;
                padding-right: 5px;
            }
            #orderDialog {
                top: 64px;
                overflow-y: scroll;
            }
            #order-products td {
                padding: 5px;
            }
        </style>
        <km-ajax id="ajax"></km-ajax>
        <div>
            <vaadin-grid id="grid" items="[[orders]]">
                <table>
                </table>
            </vaadin-grid>
            <paper-dialog id="orderDialog" no-cancel-on-outside-click>
                <h2>Order Details</h2>
                <div>
                    <table id="order-details">
                        <tr>
                            <td class="label">Order Total</td>
                            <td class="value">
                                [[_selectedProductsTotal(selectedProducts.splices)]]
                            </td>
                        </tr>
                        <tr>
                            <td class="label">Name</td>
                            <td class="value">
                                <paper-input value="{{selectedOrder.shipping_name}}" type="text"></paper-input>
                            </td>
                        </tr>
                        <tr>
                            <td class="label">Email</td>
                            <td class="value">
                                <paper-input value="{{selectedOrder.email}}" type="email"></paper-input>
                            </td>
                        </tr>
                        <tr>
                            <td class="label">Order Status</td>
                            <td class="value">
                                <paper-dropdown-menu>
                                    <paper-menu id="statusDropdown" class="dropdown-content" selected="{{selectedOrder.status}}" attr-for-selected="data-value">
                                        <paper-item data-value="started">started</paper-item>
                                        <paper-item data-value="pending">pending</paper-item>
                                        <paper-item data-value="processing">processing</paper-item>
                                        <paper-item data-value="shipped">shipped</paper-item>
                                    </paper-menu>
                                </paper-dropdown-menu>
                            </td>
                        </tr>
                        <tr>
                            <td class="label">Address Verified</td>
                            <td class="value">
                                <paper-toggle-button checked="{{selectedOrder.address_verified}}"></paper-toggle-button>
                            </td>
                        </tr>
                        <tr>
                            <td class="label">Shipping Line 1</td>
                            <td class="value">
                                <paper-input value="{{selectedOrder.shipping_line_1}}" type="text"></paper-input>
                            </td>
                        </tr>
                        <tr>
                            <td class="label">Shipping Line 2</td>
                            <td class="value">
                                <paper-input value="{{selectedOrder.shipping_line_2}}" type="text"></paper-input>
                            </td>
                        </tr>
                        <tr>
                            <td class="label">City</td>
                            <td class="value">
                                <paper-input value="{{selectedOrder.city}}" type="text"></paper-input>
                            </td>
                        </tr>
                        <tr>
                            <td class="label">State</td>
                            <td class="value">
                                <paper-input value="{{selectedOrder.state}}" type="text"></paper-input>
                            </td>
                        </tr>
                        <tr>
                            <td class="label">Postal Code</td>
                            <td class="value">
                                <paper-input value="{{selectedOrder.postal_code}}" type="text"></paper-input>
                            </td>
                        </tr>
                        <tr>
                            <td class="label">Country Code</td>
                            <td class="value">
                                <paper-input value="{{selectedOrder.country_code}}" type="text"></paper-input>
                            </td>
                        </tr>
                    </table>
                    <div>
                        <table id="order-products">
                            <thead>
                                <tr>
                                    <th>Thumbnail</th>
                                    <th>Id</th>
                                    <th>Name</th>
                                    <th>Price</th>
                                    <td>Available</td>
                                </tr>
                            </thead>
                            <tbody>
                                <template is="dom-repeat" items="{{selectedProducts}}">
                                    <tr >
                                        <td>
                                            <img src="[[item.thumbnail]]" width="50" height="50">
                                        </td>
                                        <td>[[item.id]]</td>
                                        <td>[[item.name]]</td>
                                        <td>[[item.price_label]]</td>
                                        <td>[[item.quantity]]</td>
                                    </tr>
                                </template>
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="buttons">
                    <paper-button dialog-dismiss>Close</paper-button>
                    <paper-button on-click="_save">Save</paper-button>
                </div>
            </paper-dialog>
        </div>
    </template>
    <script>
        (function () {
            Polymer({
                is: 'km-admin-orders-list',
                properties: {
                    orders: {
                        type: Array,
                        value: function(){
                            return [];
                        }
                    },
                    selectedOrder: {
                        type: Object,
                        value: function(){
                            return {};
                        }
                    },
                    selectedProducts: {
                        type: Array,
                        value: function(){
                            return [];
                        }
                    }
                },
                _selectedProductsTotal: function(){
                    if(!this.selectedProducts){
                        return 0;
                    }
                    var totalCents = 0;
                    for(var i = 0; i < this.selectedProducts.length; i++){
                        var product = this.selectedProducts[i];
                        totalCents += product.price_cents;
                    }
                    return (totalCents/100).toFixed(2);
                },
                _fetchOrders: function(){
                    var self = this;
                    var req = this.$.ajax.getOrders();
                    req.completes.then(function(){
                        var orders = req.response;
                        console.log("Orders:", orders);
                        for(var i = 0 ; i < orders.length; i++){
                            var order = orders[i];
                            order.quantity = order.product_ids.length;
                            self.push("orders", order);
                        }
                    }, function(){
                        console.log(req.response);
                    })
                },
                _orderSelected: function(){
                    var self = this;
                    var grid = this.$.grid;
                    var selectedIndexes = grid.selection.selected();
                    if(selectedIndexes.length !== 1){
                        return;
                    }
                    var selectedIndex = selectedIndexes[0];
                    this.selectedOrder = JSON.parse(JSON.stringify(this.orders[selectedIndex]));
                    console.log('Selected:', this.selectedOrder);
                    var req = this.$.ajax.getProducts(this.selectedOrder.product_ids);
                    req.completes.then(function(){
                        var products = req.response;
                        console.log("Selected Products:", products);
                        self.splice('selectedProducts', 0, self.selectedProducts.length);
                        for(var i = 0 ; i < products.length; i++){
                            var product = products[i];
                            self.push("selectedProducts", product);
                        }
                    }, function(){
                        console.log(req.response);
                    });
                    this.$.orderDialog.open();
                },
                _save: function(){
                    var self = this;
                    var order = self.selectedOrder;
                    console.log("Saving order:", order);
                    var req = self.$.ajax.updateOrder(order);
                    req.completes.then(function(){
                        console.log("Order updated successfully.");
                        for(var i = 0 ; i < self.orders.length; i++){
                            var corder = self.orders[i];
                            if(corder.id === order.id){
                                self.splice("orders", i, 1, order);
                            }
                        }
                        self.$.orderDialog.close();
                    }, function(){
                        console.log(req.response);
                    });
                },
                _sortOrderChanged: function () {
                    var table = this.$.grid;
                    var idx = table.columns[table.sortOrder[0].column].name;
                    var lesser = table.sortOrder[0].direction == 'asc' ? -1 : 1;
                    this.orders.sort(function (a, b) {
                        var av = a[idx];
                        if (av === undefined) {
                            return lesser;
                        }
                        var bv = b[idx];
                        if (bv === undefined) {
                            return -lesser;
                        }
                        return (av < bv) ? lesser : -lesser;
                    });
                },
                ready: function(){
                    var grid = this.$.grid;
                    grid.columns = [
                        {name: "email", sortable: true},
                        {name: "shipping_name", sortable: true},
                        {name: "status", sortable: true},
                        {name: "address_verified", sortable: true},
                        {name: "checkout_step", sortable: true},
                        {name: "state", sortable: true},
                        {name: "quantity", sortable: true}
                    ];

                    grid.addEventListener('selected-items-changed', this._orderSelected.bind(this));

                    grid.addEventListener('sort-order-changed', this._sortOrderChanged.bind(this));

                    this._fetchOrders();
                }
            });
        })();
    </script>
</dom-module>