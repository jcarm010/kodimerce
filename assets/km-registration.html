<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/paper-input/paper-input.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/paper-toast/paper-toast.html">
<link rel="import" href="./km-ajax.html">

<dom-module id="km-registration">
    <template>
        <style>
            :host{
                background: white;
                display: block;
                -moz-box-shadow: 0 0 3px #ccc;
                -webkit-box-shadow: 0 0 3px #ccc;
                box-shadow: 0 0 3px #ccc;
                padding:20px;
            }
            #register-button{
                float: right;
            }
            .primary {
                background-color: var(--primary-color, "blue");
                color: white;
            }
            .danger {
                background-color: var(--danger-color, "red");
                color: white;
            }
            .success {
                background-color: var(--success-color, "green");
                color: white;
            }
        </style>
        <km-ajax id="ajax"></km-ajax>
        <div id="container">
            <h3>Register</h3>
            <paper-input type="email" label="Email" value="{{email}}"></paper-input>
            <paper-input type="password" label="Password" value="{{password}}"></paper-input>
            <paper-input type="password" label="Retype Password" value="{{rePassword}}"></paper-input>
            <paper-button raised="1" on-click="_cancel">Cancel</paper-button>
            <paper-button raised="1" id="register-button" on-click="register">Register</paper-button>
        </div>
        <paper-toast class="success" id="successToast" class="fit-bottom" text=""></paper-toast>
        <paper-toast class="primary" id="messageToast" class="fit-bottom" text=""></paper-toast>
        <paper-toast class="danger" id="errorToast" class="fit-bottom" text=""></paper-toast>
    </template>
    <script>
        (function () {
            Polymer({
                is: 'km-registration',
                properties: {
                    email: "",
                    password: "",
                    rePassword: ""
                },
                register: function(){
                    var self = this;
                    var email = this.email;
                    var password = this.password;
                    var repassword = this.rePassword;
                    if(password != repassword){
                        this.showError("Passwords do not match.");
                        return;
                    }

                    console.log("Registering email["+email+"]");
                    var request = this.$.ajax.registerUser(email, password);
                    self.showMessage("Registering...");
                    request.completes.then(function(){
                        console.log("Registration successful.");
                        window.location = "/login";
                    }, function(){
                        console.log(request.response);
                        self.showError(request.response);
                    });
                },
                _cancel: function(){
                    window.location = "/";
                },
                showError: function(message){
                    this.$.errorToast.text = message;
                    this.$.errorToast.open();
                },
                showMessage: function(message){
                    this.$.messageToast.text = message;
                    this.$.messageToast.open();
                },
                showSuccess: function(message){
                    this.$.successToast.text = message;
                    this.$.successToast.open();
                },
                ready: function(){
                    this.$.messageToast.fitInto = this;
                    this.$.errorToast.fitInto = this;
                    this.$.successToast.fitInto = this;
                }
            });
        })();
    </script>
</dom-module>