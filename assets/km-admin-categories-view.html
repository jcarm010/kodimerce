<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/paper-input/paper-input.html">
<link rel="import" href="../bower_components/paper-input/paper-textarea.html">
<link rel="import" href="./km-admin-products-list.html">

<dom-module id="km-admin-categories-view">
    <template>
        <style>
            :host {
                display: block;
                padding: 10px;
            }

            .primary {
                background-color: var(--primary-color, "blue");
                color: white;
            }
            .danger {
                background-color: var(--danger-color, "red");
                color: white;
            }
            .success {
                background-color: var(--success-color, "green");
                color: white;
            }
            .details {
                margin-top:20px;
            }
        </style>
        <div>
            <div>
                <paper-button raised on-click="_cancelViewing">Back</paper-button>
                <paper-button raised class="primary" on-click="save">Save</paper-button>
            </div>
            <div class="details">
                <h4>Category Details</h4>
                <span><b>Id:</b> [[editing.id]] <b>Creation Date:</b> [[editing.created]]</span>
                <paper-input type="text" label="Name" value="{{editing.name}}"></paper-input>
                <paper-textarea label="Description" value="{{editing.description}}"></paper-textarea>
            </div>
            <div class="details">
                <h4>Products</h4>
                <km-admin-products-list id="productSelect" mode="multi" products="[[products]]"></km-admin-products-list>
            </div>
        </div>
    </template>
    <script>
        (function () {
            Polymer({
                is: 'km-admin-categories-view',
                properties: {
                    category: {
                        type: Object,
                        value: function () {
                            return null;
                        }
                    },
                    editing: {
                        type: Object,
                        value: function () {
                            return null;
                        }
                    },
                    products: {
                        type: Object,
                        value: function() {
                            return [];
                        }
                    },
                    categoryProducts: {
                        type: Array,
                        value: function(){
                            return [];
                        }
                    }
                },
                observers: [
                    '_categoryChanged(category)',
                    '_categoryProductsModified(categoryProducts)',
                    '_categoryProductsModified(categoryProducts.splices)'
                ],
                save: function(){
                    this.category = JSON.parse(JSON.stringify(this.editing));
                    this.fire("category-changed", {category: this.category, products: this.$.productSelect.selected});
                },
                _categoryProductsModified: function(){
                    if(!this.category || !this.categoryProducts){
                        return;
                    }

                    var categoryProductLookup = {};
                    for(var i = 0 ; i < this.categoryProducts.length ; i++) {
                        var categoryProduct = this.categoryProducts[i];
                        if(categoryProduct.category_id === this.category.id) {
                            categoryProductLookup[categoryProduct.product_id] = true;
                        }
                    }

                    for(i = 0; i < this.products.length; i++){
                        var product = this.products[i];
                        this.$.productSelect.select(i, categoryProductLookup[product.id] === true);
                    }
                },
                _cancelViewing: function(){
                    this.fire("viewing-canceled", {});
                },
                _categoryChanged: function (category) {
                    if(!category){
                        this.editing = null;
                        return
                    }
                    this.editing = JSON.parse(JSON.stringify(this.category));
                    this._categoryProductsModified();
                },
                ready: function(){}
            });
        })();
    </script>
</dom-module>