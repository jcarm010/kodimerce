<link rel="import" href="/bower_components/polymer/polymer.html">
<link rel="import" href="/bower_components/paper-fab/paper-fab.html">
<link rel="import" href="/bower_components/paper-button/paper-button.html">
<link rel="import" href="/bower_components/vaadin-grid/vaadin-grid.html">
<link rel="import" href="/bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="/bower_components/paper-toast/paper-toast.html">
<link rel="import" href="/bower_components/paper-input/paper-input.html">
<link rel="import" href="/bower_components/paper-toggle-button/paper-toggle-button.html">
<link rel="import" href="km-ajax.html">

<dom-module id="km-admin-products-list">
    <template>
        <style>
            :host {
                display: block;
                height: 100%;
            }
            #container {
                height: 100%;
            }
            #productsGrid {
                height: 100%;
            }
            .primary {
                background-color: var(--primary-color, "blue");
                color: white;
            }
            .danger {
                background-color: var(--danger-color, "red");
                color: white;
            }
            .success {
                background-color: var(--success-color, "green");
                color: white;
            }
        </style>
        <div id="container">
            <vaadin-grid id="productsGrid" items="[[products]]">
                <table>
                </table>
            </vaadin-grid>
        </div>
    </template>
    <script>
        (function () {
            Polymer({
                is: 'km-admin-products-list',
                properties: {
                    products: {
                        type: Array,
                        value: function(){
                            return [];
                        }
                    },
                    selectedProduct: {
                        type: Object,
                        value: function(){
                            return null;
                        }
                    }
                },
                openCreateModal: function(){
                    this.$.createModal.open();
                },
                showError: function(message){
                    this.$.errorToast.text = message;
                    this.$.errorToast.open();
                },
                showMessage: function(message){
                    this.$.messageToast.text = message;
                    this.$.messageToast.open();
                },
                showSuccess: function(message){
                    this.$.successToast.text = message;
                    this.$.successToast.open();
                },
                _sortOrderChanged: function(){
                    var self = this;
                    var table = self.$.productsGrid;
                    return function () {
                        var idx = table.columns[table.sortOrder[0].column].name;
                        var lesser = table.sortOrder[0].direction == 'asc' ? -1 : 1;
                        self.products.sort(function (a, b) {
                            var av = a[idx];
                            if (av === undefined) {
                                return lesser;
                            }
                            var bv = b[idx];
                            if (bv === undefined) {
                                return -lesser;
                            }
                            return (av < bv) ? lesser : -lesser;
                        });
                    }
                },
                _productSelected: function(){
                    var self = this;
                    var grid = self.$.productsGrid;
                    return function(){
                        var selectedIndex = grid.selection.selected();
                        var selected = grid.items[selectedIndex];
                        if(!selected){
                            return;
                        }

                        self.selectedProduct = selected;
                        self.fire("selected-product", selected);
                        grid.selection.clear();
                    }
                },
                _centsRenderer: function(){
                    var self = this;
                    return function(cell){
                        var index = cell.row.index;
                        var product = self.products[index];
                        cell.element.innerHTML = '$'+(product.price_cents/100).toFixed(2);
                    };
                },
                _booleanRenderer: function(){
                    return function(cell){
                        var toggle;
                        if(!cell.element.innerHTML || cell.element.innerHTML===""){
                            toggle = document.createElement('paper-toggle-button');
                            cell.element.appendChild(toggle);
                        }else {
                            toggle = cell.element.children[0];
                        }

                        toggle.checked = cell.data;
                    };
                },
                ready: function(){
                    var grid = this.$.productsGrid;

                    grid.columns = [
                        {name: "id", sortable: true},
                        {name: "name", sortable: true},
                        {name: "price", sortable: true, renderer: this._centsRenderer()},
                        {name: "quantity", sortable: true},
                        {name: "active", sortable: true, renderer: this._booleanRenderer()},
                        {name: "created", sortable: true}
                    ];

                    grid.addEventListener('sort-order-changed', this._sortOrderChanged());
                    grid.addEventListener('selected-items-changed', this._productSelected());
                }
            });
        })();
    </script>
</dom-module>