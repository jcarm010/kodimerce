<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/iron-ajax/iron-ajax.html">

<dom-module id="km-ajax">
    <template>
        <iron-ajax id="xhrGet" handle-as="json" method="GET" headers="[[headers]]"></iron-ajax>
        <iron-ajax id="xhrPut" handle-as="json" method="PUT" headers="[[headers]]"></iron-ajax>
        <iron-ajax id="xhrDelete" handle-as="json" method="DELETE" headers="[[headers]]"></iron-ajax>
        <iron-ajax id="xhr" handle-as="json" method="POST" headers="[[headers]]"></iron-ajax>
    </template>
    <script>
        (function () {
            Polymer({
                is: 'km-ajax',
                properties: {
                    headers: {
                        type: Object,
                        value: function(){
                            return {}
                        }
                    }
                },
                del: function (url) {
                    this.$.xhrDelete.url = url;
                    this.$.xhrDelete.contentType = "application/x-www-form-urlencoded";
                    var r = this.$.xhrDelete.generateRequest();
                    return r.completes;
                },
                put: function (url, data) {
                    this.$.xhrPut.url = url;
                    this.$.xhrPut.contentType = "application/x-www-form-urlencoded";
                    this.$.xhrPut.body = urlSerialize(data);
                    var r = this.$.xhrPut.generateRequest();
                    return r;
                },
                post: function (url, data) {
                    this.$.xhr.url = url;
                    this.$.xhr.contentType = "application/x-www-form-urlencoded";
                    this.$.xhr.body = urlSerialize(data);
                    var r = this.$.xhr.generateRequest();
                    return r;
                },
                get:function(url){
                    this.$.xhrGet.url = url;
                    this.$.xhrGet.contentType = "application/json";
                    var r = this.$.xhrGet.generateRequest();
                    return r;
                },
                ready: function () {},
                //calls
                registerUser: function(email, password){
                    return this.post("/register", {email: email, password: password})
                },
                loginUser: function(email, password){
                    return this.post("/login", {email: email, password: password})
                },
                adminCreateProduct: function (name) {
                    return this.post("/admin/km/product/?name="+encodeURIComponent(name)).completes;
                },
                adminGetProducts: function(){
                    return this.get("/admin/km/product/").completes;
                },
                adminUpdateProducts: function(product){
                    return this.put("/admin/km/product/", product).completes;
                },
                adminCreateCategory: function(name) {
                    return this.post("/admin/km/category/?name="+encodeURIComponent(name)).completes;
                },
                adminGetCategories: function(){
                    return this.get("/admin/km/category/").completes;
                },
                adminUpdateCategory: function(category){
                    return this.put("/admin/km/category/", category).completes;
                },
                adminGetCategoryProducts: function(){
                    return this.get("/admin/km/category_products/").completes;
                },
                adminSetCategoryProducts: function(categoryProducts){
                    return this.post("/admin/km/category_products/", categoryProducts).completes;
                },
                adminUnsetCategoryProducts: function(categoryProducts){
                    var query = "";
                    for(var i = 0 ; i < categoryProducts.length; i++){
                        if(i !== 0){
                            query += "&";
                        }

                        var cp = categoryProducts[i];
                        for(var key in cp){
                            query += encodeURIComponent(key)+"="+encodeURIComponent(cp[key]);
                        }
                    }

                    return this.del("/admin/km/category_products/?"+query);
                },
                createOrder: function(items){
                    var itemIds = [];
                    for( var i = 0 ; i < items.length; i++ ){
                        var item = items[i];
                        itemIds.push(item.id);
                    }
                    console.log("Creating order with itemsIds:", itemIds);
                    return this.post("/order/", {product_ids: itemIds});
                },
                updateOrder: function(order){
                    return this.put("/order/", order);
                },
                getProducts: function(productIds){
                    return this.get("/api/product?"+urlSerialize({ids:productIds}))
                },
                confirmOrder: function(orderId){
                    return this.post("/paypal/payment", {id:orderId});
                },
                checkOrderAddress: function(order){
                    return this.post("/order/address/verify", order);
                }
            });
            function urlSerialize(obj) {
                var str = [];
                for(var p in obj)
                    if (obj.hasOwnProperty(p)) {
                        var value = obj[p];
                        if(value === undefined){
                              value = "";
                        }else if(value.constructor === Array){
                            value = value.join();
                        }

                        str.push(encodeURIComponent(p) + "=" + encodeURIComponent(value));
                    }
                return str.join("&");
            }
        })();
    </script>
</dom-module>