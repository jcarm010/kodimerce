<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="./km-ajax.html">

<dom-module id="km-checkout-payinfo">
    <template>
        <style>
            :host{
                padding:10px;
                width: 300px;
                display: inline-block;
                border: 1px solid rgb(237,237,237);
                margin-bottom: 20px;
                margin-top: 20px;
            }
        </style>
        <km-ajax id="ajax"></km-ajax>
        <div>
            <div id="paypal-button"></div>
        </div>
    </template>
    <script>
        (function () {
            Polymer({
                is: 'km-checkout-payinfo',
                properties: {
                    order: {
                        type: Object,
                        value: function(){
                            return {};
                        },
                        notify: true,
                        observer: '_order_changed'
                    }
                },
                _order_changed: function(){
                    console.log("Order:", this.order);
                },
                submit: function(){
                    console.log("Submitting Payment Info");
                },
                performAction: function(){
                    var order = this.order;
                    var nextStep = "confirm";
                    order.checkout_step = nextStep;
                    document.location = "/checkout/" + nextStep + "?order=" + order.id;
                },
                ready: function(){
                    var self = this;
                    paypal.Button.render({

//                        env: 'production', // Specify 'sandbox' for the test environment
                        env: 'sandbox', // Specify 'sandbox' for the test environment

                        payment: function(resolve, reject) {
                            // Set up the payment here, when the buyer clicks on the button
                            console.log("On Payment:", self.order);
                            var CREATE_PAYMENT_URL = '/paypal/payment/?order='+self.order.id;

                            paypal.request.get(CREATE_PAYMENT_URL)
                                    .then(function(data) {
                                        console.log("Create payment completed!");
                                        if(data.error && data.error != ""){
                                            kmApp.showError(data.error);
                                            reject(data.error);
                                        }else {
                                            resolve(data.paymentID);
                                        }
                                    })
                                    .catch(function(err) {
                                        console.log("Create payment error: ", err);
                                        reject(err);
                                        kmApp.showError(err);
                                        reject();
                                    });
                        },

                        onAuthorize: function(data, actions) {
                            // Execute the payment here, when the buyer approves the transaction
                            console.log("On Authorize:", data);
                            var order = self.order;
                            order.paypal_payer_id = data.payerID;
                            var req = self.$.ajax.updateOrder(self.order);
                            req.completes.then(function(){
                                console.log("Payment info saved!");
                                var nextStep = "confirm";
                                order.checkout_step = nextStep;
                                document.location = "/checkout/" + nextStep + "?order=" + order.id;
                            }, function(){
                                console.log(req.response);
                                kmApp.showError(req.response);
                            });
                        },
                        onCancel: function(data, actions){
                            console.log("Paypal payment canceled");
                        }

                    }, '#paypal-button');
                }
            });
        })();
    </script>
</dom-module>