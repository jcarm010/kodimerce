<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/app-route/app-location.html">
<link rel="import" href="../bower_components/app-route/app-route.html">
<link rel="import" href="../bower_components/iron-pages/iron-pages.html">
<link rel="import" href="../bower_components/paper-fab/paper-fab.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/vaadin-grid/vaadin-grid.html">
<link rel="import" href="../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../bower_components/paper-toast/paper-toast.html">
<link rel="import" href="../bower_components/paper-input/paper-input.html">
<link rel="import" href="./km-ajax.html">

<dom-module id="km-admin-products">
    <template>
        <style>
            :host {
                display: block;
                height: 100%;
            }
            #container {
                min-height: 100%;
            }
            #productsGrid {
                height: 100%;
            }
            #add-icon {
                position: fixed;
                bottom: 10px;
                right: 10px;
            }
            .primary {
                background-color: var(--primary-color, "blue");
                color: white;
            }
            .danger {
                background-color: var(--danger-color, "red");
                color: white;
            }
            .success {
                background-color: var(--success-color, "green");
                color: white;
            }
            iron-pages{
                min-height: 100%;
                background: white;
            }
            #createModal{
                width: 450px;
            }
        </style>
        <app-location route="{{route}}"></app-location>
        <app-route
                id="approute"
                route="{{route}}"
                pattern="/admin/products/:page"
                data="{{routeData}}"
                tail="{{subroute}}">

        </app-route>


        <km-ajax id="ajax"></km-ajax>
        <div id="container">
            <iron-pages role="main" selected="[[page]]" attr-for-selected="name">
                <km-admin-products-list id="productList" name="all" products="[[products]]" on-selected-product="_productSelected"></km-admin-products-list>
                <km-admin-products-view id="viewingProduct" name="view"
                                        on-viewing-canceled="_viewingCanceled"
                                        on-product-changed="_selectedChanged"
                                        product="[[selectedProduct]]"
                                        categories="[[categories]]"
                                        category-products="[[categoryProducts]]">

                </km-admin-products-view>
            </iron-pages>


            <paper-fab class="primary" id="add-icon" icon="add" on-click="openCreateModal"></paper-fab>

            <paper-dialog id="createModal">
                <h2>Create Product</h2>
                <p>
                    <paper-input label="Product Name" value="{{newProductName}}"></paper-input>
                </p>
                <div class="buttons">
                    <paper-button dialog-confirm>Cancel</paper-button>
                    <paper-button class="primary" on-click="createProduct">Create</paper-button>
                </div>
            </paper-dialog>
        </div>
        <paper-toast class="success" id="successToast" class="fit-bottom" text=""></paper-toast>
        <paper-toast class="primary" id="messageToast" class="fit-bottom" text=""></paper-toast>
        <paper-toast class="danger" id="errorToast" class="fit-bottom" text=""></paper-toast>
    </template>
    <script>
        (function () {
            Polymer({
                is: 'km-admin-products',
                properties: {
                    page: {
                        type: String,
                        reflectToAttribute: true,
                        observer: '_pageChanged'
                    },
                    newProductName: {
                        type: String,
                        value: ""
                    },
                    products: {
                        type: Array,
                        value: function(){
                            return [];
                        },
                        notify:true
                    },
                    selectedProduct: {
                        type: Object,
                        value: function(){
                            return null;
                        }
                    },
                    selectedProductId: {
                        type: Number,
                        value: 0
                    },
                    categoryProducts: {
                        type: Array,
                        value: function(){
                            return [];
                        },
                        notify:true
                    },
                    categories: {
                        type: Array,
                        value: function(){
                            return [];
                        }
                    }
                },
                observers: [
                    '_routePageChanged(routeData.page)',
                    '_setSelectedProduct(products.splices)',
                    '_setSelectedProduct(products)'
                ],
                _routePageChanged: function (page) {
                    switch(page){
                        case undefined:
                        case null:
                        case "":
                        case "all":
                            this.page = "all";
                            break;
                        default:
                            this.setSelectedProduct(parseInt(page));
                            this.page = "view";
                    }
                },
                _pageChanged: function (page) {
                    switch(page){
                        case "all":
                            page = "list";
                            break;
                        default:
                            page = "view"
                    }
                    this.importHref(this.resolveUrl("km-admin-products-" + page + '.html'), null, null, true);
                },
                openCreateModal: function(){
                    this.$.createModal.open();
                },
                createProduct: function(){
                    var self = this;
                    console.log("Creating product...");
                    var name = self.newProductName;
                    self.showMessage("Creating product: " + name);
                    this.$.ajax.adminCreateProduct(name).then(function(data){
                        var response = data.response;
                        console.log("Product created successfully:", response);
                        self.newProductName = "";
                        self.showSuccess("Product created: " + name);
                        self.$.createModal.close();
                        self.push('products', response);
                    }, function(data){
                        console.log(data);
                        self.showError("Could not create product, check your input and try again.");
                    });
                },
                setSelectedProduct: function(productId){
                    if(!productId){
                        return;
                    }

                    this.selectedProductId = productId;
                    for(var i = 0 ; i < this.products.length; i++){
                        var product = this.products[i];
                        if(product.id === productId){
                            this.selectedProduct = null;
                            this.selectedProduct = product;
                            break;
                        }
                    }
                },
                showError: function(message){
                    this.$.errorToast.text = message;
                    this.$.errorToast.open();
                },
                showMessage: function(message){
                    this.$.messageToast.text = message;
                    this.$.messageToast.open();
                },
                showSuccess: function(message){
                    this.$.successToast.text = message;
                    this.$.successToast.open();
                },
                _setSelectedProduct: function(){
                    this.setSelectedProduct(this.selectedProductId);
                },
                _saveProduct(product){
                    var self = this;
                    self.showMessage("Saving changes to product: " + product.name);
                    return self.$.ajax.adminUpdateProducts(product).then(function(data){
                        console.log("Product updated");
                        self.showSuccess("Product " + product.name + " was updated.");
                        for(var i = 0; i < self.products.length; i++){
                            var p = self.products[i];
                            if(p.id === product.id){
                                self.splice("products", i, 1, product);
                                break;
                            }
                        }
                        self.set('route.path', "/admin/products/all");
                        var products = self.products;
                        self.products = [];
                        self.products = products;
                    }, function(data){
                        console.log("Failed to update:", data);
                        self.showError("Failed to update the product, please refresh this page and try again later.")
                    })
                },
                _selectedChanged: function(evt){
                    var self = this;
                    var product = evt.detail.product;
                    var categories = evt.detail.categories;

                    var categoryLookup = {};
                    var categoryProducts = {};
                    for(var i = 0 ; i < categories.length; i++){
                        var category = categories[i];
                        categoryLookup[""+category.id] = true;
                        categoryProducts[""+category.id] = ""+product.id;
                    }

                    var toRemove = [];
                    for(i=0 ; i < self.categoryProducts.length; i++){
                        var categoryProduct = self.categoryProducts[i];
                        if(categoryProduct.product_id === product.id && !categoryLookup[""+categoryProduct.category_id]) {
                            var cStr = ""+categoryProduct.category_id;
                            var pStr = ""+categoryProduct.product_id;
                            var p = {};
                            p[cStr] = pStr;
                            toRemove.push(p);
                        }
                    }

                    console.log("Selected product changed:", product);
                    self._saveProduct(product).then(function(){
                        self.showMessage("Removing categories...");
                        console.log("Removing categories:", toRemove);
                        self.$.ajax.adminUnsetCategoryProducts(toRemove).then(function(evt){
                            self.showSuccess("Categories removed.");
                            for(i=0 ; i < self.categoryProducts.length; i++){
                                var categoryProduct = self.categoryProducts[i];
                                if(categoryProduct.product_id === product.id && !categoryLookup[""+categoryProduct.category_id]) {
                                    console.log("Removing:", categoryProduct);
                                    self.splice('categoryProducts', i, 1);
                                    i--;
                                    delete categoryLookup[""+categoryProduct.product_id];
                                } else if(categoryProduct.category_id === category.id && categoryLookup[""+categoryProduct.product_id]){
                                    delete categoryLookup[""+categoryProduct.product_id];
                                }
                            }
                        }, function(evt){
                            console.log(evt);
                            self.showError("Failed to unset category products.");
                        }).then(function(evt){
                            var toAdd = [];
                            for (var categoryId in categoryLookup) {
                                if(!categoryLookup.hasOwnProperty(categoryId)){
                                    continue;
                                }
                                toAdd.push(categoryId+":"+product.id);
                            }

                            self.showMessage("Adding categories...");
                            console.log("Adding categories:", toAdd);
                            self.$.ajax.adminSetCategoryProducts({to_add: toAdd}).then(function(evt){
                                self.showSuccess("Categories added.");
                                for (var categoryId in categoryLookup) {
                                    if(!categoryLookup.hasOwnProperty(categoryId)){
                                        continue;
                                    }
                                    var cp = {category_id: parseInt(categoryId), product_id: product.id};
                                    console.log("Adding:", cp);
                                    self.push('categoryProducts', cp);
                                }
                            }, function(evt){
                                console.log(evt);
                                self.showError("Failed to set category products.");
                            });
                        });
                    })
                },
                _productSelected: function(evt){
                    var selected = evt.detail[0];
                    if(!selected){
                        return;
                    }

                    this.set('route.path', "/admin/products/"+selected.id);
                },
                _viewingCanceled: function(){
                    this.set('route.path', "/admin/products/all");
                },
                ready: function(){
                    this.$.messageToast.fitInto = this.$.container;
                    this.$.errorToast.fitInto = this.$.container;
                    this.$.successToast.fitInto = this.$.container;
                }
            });
        })();
    </script>
</dom-module>