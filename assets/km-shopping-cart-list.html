<link rel="import" href="/bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="km-ajax.html">

<dom-module id="km-shopping-cart-list">
    <template>
        <style>
            .product-image{
                height: 100px;
                width: 100px;
                padding: 0;
                margin-top: 10px;
                margin-right: 10px;
            }
            paper-icon-button.close-icon {
               color: #dedede;
            }
            .right-aligned{
                text-align: right;
            }
            paper-button.checkout{
                width: 150px;
                background-color: #F4F3F4;
                margin:20px 0;
            }
            #dialog {
                min-width: 300px;
            }
        </style>
        <km-ajax id="ajax"></km-ajax>
        <div>
            <table style="width:100%">
                <template is="dom-repeat" items="{{cartItems}}">
                    <tr style="border-bottom: 2px solid #F4F3F4">
                        <td>
                            <paper-icon-button src="[[item.thumbnail]]"
                                               class="product-image"
                                               title="Product Image">
                            </paper-icon-button>{{item.name}}
                        </td>
                        <td class="right-aligned">
                            <paper-icon-button class="close-icon"
                                icon="close"
                                title="Remove"
                                on-click="_removeCartItem">
                            </paper-icon-button><br>
                            {{item.price_label}}
                        </td>
                    </tr>
                </template>
                <tr style="height: 50px;">
                    <td></td>
                    <td class="right-aligned" style="border-bottom: 2px solid #F4F3F4">
                        <span style="margin-right: 50px; color: #969696">Subtotal</span>
                        <span>[[totalPrice]]</span>
                    </td>
                </tr>
            </table>
            <div class="right-aligned">
                <paper-button on-click="_checkout" class="checkout">Checkout</paper-button>
            </div>
        </div>
        <paper-dialog id="dialog">
            <h2>Oops...</h2>
            <p>[[errorMessage]]</p>
        </paper-dialog>
    </template>
    <script>
        (function () {
            Polymer({
                is: 'km-shopping-cart-list',
                properties: {
                    cartItems:{
                        type:Array,
                        value:function(){
                            return [];
                        }
                    },
                    totalPrice:{
                        type:String,
                        value:""
                    },
                    errorMessage: {
                        type: String,
                        value: ""
                    }
                },
                observers: [
                    '_cartItemsChanged(cartItems.splices)',
                    '_cartItemsChanged(cartItems)'
                ],
                _cartItemsChanged:function(){
                    var total = 0;
                    for(var i=0; i<this.cartItems.length; i++){
                        total+=this.cartItems[i].price_cents;
                    }
                    var dollars = (total/100).toFixed(2);
                    this.set("totalPrice", "$"+dollars);
                },
                _removeCartItem:function(e){
                    var index = e.model.index;
                    this.splice("cartItems", index, 1);
                    var shoppingCartItems = localStorage.getItem('shoppingCartItems');
                    if(!shoppingCartItems){
                        return
                    }
                    var items = JSON.parse(shoppingCartItems);
                    items.splice(index, 1);
                    localStorage.setItem('shoppingCartItems', JSON.stringify(items));

                    var event = new CustomEvent("shoppingCartChanged", {});
                    document.dispatchEvent(event);
                },
                _checkout: function(){
                    var self = this;
                    var req = this.$.ajax.createOrder(this.cartItems);
                    req.completes.then(function(data){
                        var order = data.response;
                        console.log("New Order:", order);
                        document.location = "/checkout/shipinfo?order=" + order.id;
                    }, function(data){
                        console.log(req.response);
                        self.errorMessage = req.response;
                        self.$.dialog.open();
                    });
                },
                computeFullName(cartItems){
                    var total = 0;
                    for(var i=0; i<cartItems.length; i++){
                        total+=cartItems[i].price_cents;
                    }
                    return total;
                },
                ready: function(){
                    var shoppingCartItems = localStorage.getItem('shoppingCartItems');
                    var cartItems=[];
                    if(shoppingCartItems!==null){
                        cartItems = JSON.parse(shoppingCartItems)
                    }
                    var args = ['cartItems', 0, this.cartItems.length].concat(cartItems);
                    this.splice.apply(this, args);
                    console.log("Cart Items: ", cartItems);
                }

            });
        })();
    </script>
</dom-module>