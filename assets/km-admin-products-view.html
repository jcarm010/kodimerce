<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/paper-input/paper-input.html">
<link rel="import" href="../bower_components/paper-input/paper-textarea.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/paper-card/paper-card.html">
<link rel="import" href="../bower_components/paper-toggle-button/paper-toggle-button.html">
<link rel="import" href="./km-admin-categories-list.html">

<dom-module id="km-admin-products-view">
    <template>
        <style>
            :host {
                display: block;
                padding: 10px;
            }

            .primary {
                background-color: var(--primary-color, "blue");
                color: white;
            }
            .danger {
                background-color: var(--danger-color, "red");
                color: white;
            }
            .success {
                background-color: var(--success-color, "green");
                color: white;
            }
            .details {
                margin-top:20px;
            }
            paper-card {
                max-width: 250px;
            }
        </style>
        <div>
            <div>
                <paper-button raised on-click="_cancelViewing">Back</paper-button>
                <paper-button raised class="primary" on-click="save">Save</paper-button>
            </div>
            <div class="details">
                <h4>Product Details</h4>
                <span><b>Id:</b> [[editing.id]] <b>Creation Date:</b> [[editing.created]]</span>
                <paper-toggle-button checked="{{editing.active}}">Active</paper-toggle-button>
                <paper-input type="text" label="Name" value="{{editing.name}}"></paper-input>
                <paper-input type="number" label="Price Cents" value="{{editing.price}}" step="0.01">
                    <div prefix>$</div>
                </paper-input>
                <paper-input type="number" label="Quantity" value="{{editing.quantity}}"></paper-input>
                <paper-textarea label="Description" value="{{editing.description}}"></paper-textarea>
            </div>
            <div class="details">
                <h4>Product Images</h4>
                <paper-button raised on-click="addPicture">Add Image</paper-button>
                <div style="margin-top: 5px;">
                    <template is="dom-repeat" items="{{editing.pictures}}">
                        <div style="margin-top: 5px; display: inline;">
                            <paper-card heading="" image="[[item]]" alt="thumnail" class="white" style="margin-bottom:8px;">
                                <div class="card-actions">
                                    <paper-input label="Url" name="[[index]]" value="[[getPicture(index)]]" on-change="setPicture"></paper-input>
                                </div>
                            </paper-card>
                        </div>
                    </template>
                </div>
            </div>
            <div class="details">
                <h4>Categories</h4>
                <km-admin-categories-list id="categoriesSelect" mode="multi" categories="[[categories]]"></km-admin-categories-list>
            </div>
        </div>
    </template>
    <script>
        (function () {
            Polymer({
                is: 'km-admin-products-view',
                properties: {
                    product: {
                        type: Object,
                        value: function () {
                            return null;
                        }
                    },
                    editing: {
                        type: Object,
                        value: function () {
                            return null;
                        }
                    },
                    categories: {
                        type: Array,
                        value: function(){
                            return [];
                        }
                    },
                    categoryProducts: {
                        type: Array,
                        value: function(){
                            return [];
                        }
                    }
                },
                observers: [
                    '_productChanged(product)',
                    '_categoryProductsModified(categoryProducts)',
                    '_categoryProductsModified(categoryProducts.splices)'
                ],
                _categoryProductsModified: function(){
                    if(!this.product || !this.categoryProducts){
                        return;
                    }

                    var categoryProductLookup = {};
                    for(var i = 0 ; i < this.categoryProducts.length ; i++) {
                        var categoryProduct = this.categoryProducts[i];
                        if(categoryProduct.product_id === this.product.id) {
                            categoryProductLookup[categoryProduct.category_id] = true;
                        }
                    }

                    for(i = 0; i < this.categories.length; i++){
                        var category = this.categories[i];
                        this.$.categoriesSelect.select(i, categoryProductLookup[category.id] === true);
                    }
                },
                setPicture: function(evt){
                    var input = evt.target;
                    console.log("Editing image path: ", 'editing.pictures.'+input.name);
                    if(input.value == ""){
                        this.splice('editing.pictures', input.name, 1);
                    }else {
                        this.splice('editing.pictures', input.name, 1, input.value);
                    }
                },
                getPicture: function(index){
                    return this.editing.pictures[index];
                },
                addPicture: function(){
                    this.push('editing.pictures',"/assets/images/stock.jpeg")
                },
                save: function(){
                    var editing = JSON.parse(JSON.stringify(this.editing));
                    editing.price_cents = Math.floor(editing.price * 100);
                    delete editing['price'];
                    this.product = editing;
                    this.fire("product-changed", {product: this.product, categories: this.$.categoriesSelect.selected});
                },
                _cancelViewing: function(){
                    this.fire("viewing-canceled", {});
                },
                _productChanged: function(product){
                    if(!product){
                        this.editing = null;
                        return
                    }
                    console.log("Editing product:", this.product);
                    var editing = JSON.parse(JSON.stringify(this.product));
                    editing.price = this.product.price_cents/100;
                    this.editing = editing;
                    this._categoryProductsModified();
                },
                ready: function(){}
            });
        })();
    </script>
</dom-module>