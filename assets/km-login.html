<link rel="import" href="/bower_components/polymer/polymer.html">
<link rel="import" href="/bower_components/paper-header-panel/paper-header-panel.html">
<link rel="import" href="/bower_components/paper-input/paper-input.html">
<link rel="import" href="/bower_components/paper-input/paper-textarea.html">
<link rel="import" href="/bower_components/paper-button/paper-button.html">
<link rel="import" href="/bower_components/paper-spinner/paper-spinner-lite.html">
<link rel="import" href="/bower_components/iron-ajax/iron-request.html">
<link rel="import" href="/bower_components/iron-form/iron-form.html">
<link rel="import" href="/bower_components/paper-toast/paper-toast.html">

<dom-module id="login-component">
    <template>
        <style>
            paper-header-panel {
                box-shadow: 0 2px 2px 0 rgba(0, 0, 0, 0.14), 0 1px 5px 0 rgba(0, 0, 0, 0.12), 0 3px 1px -2px rgba(0, 0, 0, 0.2);
            }
            paper-header-panel .content {
                padding: 10px;
            }
            paper-header-panel .paper-header {
                padding: 10px;
                background-color: var(--paper-indigo-500);
                color: white;
            }
            paper-button {
                width: 100%;
                margin: 0;
            }
            paper-button.indigo {
                background-color: var(--paper-indigo-500);
                color: white;
                --paper-button-raised-keyboard-focus: {
                    color: white !important;
                };
            }
            paper-spinner-lite {
                --paper-spinner-stroke-width: 1px;
                --paper-spinner-color: var(--google-green-500);
                margin-left: 5px;
            }
            #errorToast {
                --paper-toast-background-color: #d58512;
                --paper-toast-color: white;
            }
            *[hidden] {
                visibility: hidden;
            }
        </style>
        <div style="height: 250px;">
            <iron-request id="xhr"></iron-request>
            <paper-header-panel id="formPanel" mode="standard">
                <div class="paper-header">
                    <h5>Login</h5>
                </div>
                <div class="content">
                    <form is="iron-form" method="post" action="/login" with-credentials="true" on-iron-form-response="submissionDone" on-iron-form-error="submissionDone">
                        <paper-input type="email" name="email" label="Email" required auto-validate></paper-input>
                        <paper-input name="password" label="Password" type="password" required auto-validate></paper-input>
                        <paper-button raised class="custom indigo" on-click="submit" disabled="{{loading}}">
                            <span hidden="{{loading}}">Login</span>
                            <paper-spinner-lite class="green" hidden="{{!loading}}" active></paper-spinner-lite>
                        </paper-button>
                    </form>
                </div>
                <paper-toast id="errorToast" class="fit-bottom" text="[[errorMessage]]"></paper-toast>
            </paper-header-panel>
        </div>

    </template>
    <script>
        Polymer({
            is: 'login-component',
            properties: {
                loading: {
                    type: Boolean,
                    value: false
                },
                errorMessage: {
                    type: String,
                    value: ""
                }
            },
            submissionDone: function(req){
                if(req.detail.succeeded){
                    console.log("Succeeded!");
                    window.location = "/login/landing";
                }else{
                    var response = req.detail.request.response;
                    console.log("Failed: " + response);
                    if(response === null){
                        response = "Unexpected error, please try again later.";
                    }
                    this.errorMessage = response;
                    this.$.errorToast.open();
                }
                this.loading = false;
            },
            submit: function(event){
                var self = this;
                console.log("Submitting Login");
                console.log(event);
                var form = Polymer.dom(event).localTarget.parentElement;
                if(form.validate()){
                    self.loading = true;
                }
                form.submit();
            },
            ready: function(){
                this.$.errorToast.fitInto=this.$.formPanel;
            }
        });
    </script>
</dom-module>