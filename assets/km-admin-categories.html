<link rel="import" href="/bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/app-route/app-location.html">
<link rel="import" href="../bower_components/app-route/app-route.html">
<link rel="import" href="../bower_components/iron-pages/iron-pages.html">
<link rel="import" href="../bower_components/paper-fab/paper-fab.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/vaadin-grid/vaadin-grid.html">
<link rel="import" href="../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../bower_components/paper-toast/paper-toast.html">
<link rel="import" href="../bower_components/paper-input/paper-input.html">
<link rel="import" href="./km-ajax.html">

<dom-module id="km-admin-categories">
    <template>
        <style>
            :host{
                display: block;
                height: 100%;
            }
            #container {
                min-height: 100%;
            }
            #productsGrid {
                height: 100%;
            }
            #add-icon {
                position: fixed;
                bottom: 10px;
                right: 10px;
            }
            .primary {
                background-color: var(--primary-color, "blue");
                color: white;
            }
            .danger {
                background-color: var(--danger-color, "red");
                color: white;
            }
            .success {
                background-color: var(--success-color, "green");
                color: white;
            }
            iron-pages{
                min-height: 100%;
                background: white;
            }
            #createModal{
                width: 450px;
            }
        </style>
        <app-location route="{{route}}"></app-location>
        <app-route
                id="approute"
                route="{{route}}"
                pattern="/admin/categories/:page"
                data="{{routeData}}"
                tail="{{subroute}}">

        </app-route>

        <km-ajax id="ajax"></km-ajax>
        <div id="container">
            <iron-pages role="main" selected="[[page]]" attr-for-selected="name">
                <km-admin-categories-list id="categoriesList" name="all" categories="[[categories]]"></km-admin-categories-list>
                <km-admin-categories-view id="viewingCategory"
                                          name="view"
                                          on-viewing-canceled="_viewingCanceled"
                                          category="[[selectedCategory]]"
                                          products="[[products]]"
                                          on-category-changed="_selectedChanged">

                </km-admin-categories-view>
            </iron-pages>


            <paper-fab class="primary" id="add-icon" icon="add" on-click="openCreateModal"></paper-fab>

            <paper-dialog id="createModal">
                <h2>Create Category</h2>
                <p>
                    <paper-input label="Category Name" value="{{newCategoryName}}"></paper-input>
                </p>
                <div class="buttons">
                    <paper-button dialog-confirm>Cancel</paper-button>
                    <paper-button class="primary" on-click="createCategory">Create</paper-button>
                </div>
            </paper-dialog>
        </div>
        <paper-toast class="success" id="successToast" class="fit-bottom" text=""></paper-toast>
        <paper-toast class="primary" id="messageToast" class="fit-bottom" text=""></paper-toast>
        <paper-toast class="danger" id="errorToast" class="fit-bottom" text=""></paper-toast>
    </template>
    <script>
        (function () {
            Polymer({
                is: 'km-admin-categories',
                properties: {
                    page: {
                        type: String,
                        reflectToAttribute: true,
                        observer: '_pageChanged'
                    },
                    categories: {
                        type: Array,
                        value: function(){
                            return [];
                        }
                    },
                    newCategoryName: {
                        type: String,
                        value: ""
                    },
                    selectedCategoryId: {
                        type: Number,
                        value: 0
                    },
                    selectedCategory: {
                        type: Object,
                        value: function(){
                            return null;
                        }
                    },
                    products: {
                        type: Object,
                        value: function() {
                            return [];
                        }
                    }
                },
                observers: [
                    '_routePageChanged(routeData.page)'
                ],
                _selectedChanged: function(evt){
                    var self = this;
                    console.log("Selected category changed:", evt.detail);
                    var category = evt.detail.category;
                    var products = evt.detail.products;
                    var productIds = [];
                    for(var i = 0 ; i < products.length; i++){
                        var product = products[i];
                        productIds.push(product.id);
                    }
                    category.product_ids = productIds;
                    self.showMessage("Saving changes to category: " + category.name);
                    self.$.ajax.adminUpdateCategory(category).then(function(data){
                        delete category.product_ids;
                        console.log("Category updated");
                        self.showSuccess("Category " + category.name + " was updated.");
                        for(var i = 0; i < self.categories.length; i++){
                            var p = self.categories[i];
                            if(p.id === category.id){
                                self.splice("categories", i, 1, category);
                                break;
                            }
                        }
                        self.set('route.path', "/admin/categories/all");
                        var categories = self.categories;
                        self.categories = [];
                        self.categories = categories;
                    }, function(data){
                        delete delete category.product_ids;
                        console.log("Failed to update:", data);
                        self.showError("Failed to update the category, please refresh this page and try again later.");
                    });
                },
                _routePageChanged: function (page) {
                    switch(page){
                        case undefined:
                        case null:
                        case "":
                        case "all":
                            this.page = "all";
                            break;
                        default:
                            this.setSelectedCategory(parseInt(page));
                            this.page = "view";
                    }
                },
                _pageChanged: function (page) {
                    switch(page){
                        case "all":
                            page = "list";
                            break;
                        default:
                            page = "view"
                    }
                    this.importHref(this.resolveUrl("km-admin-categories-" + page + '.html'), null, null, true);
                },
                _fetchCategories: function(){
                    var self = this;
                    self.showMessage("Fetching categories...");
                    return this.$.ajax.adminGetCategories().then(function(data){
                        var categories = data.response;
                        console.log("Categories:", categories);

                        var pushParams = ['categories'];
                        for(var i = 0 ; i < categories.length; i++){
                            var category = categories[i];
                            pushParams.push(category);
                        }

                        self.splice("categories", 0, self.categories.length);
                        self.push.apply(self, pushParams);
                        self.setSelectedCategory(self.selectedCategoryId);
                        self.showSuccess("Categories fetched");
                    }, function(data){
                        console.log(data);
                        self.showError("Could not fetch categories, please try again later.")
                    })
                },
                setSelectedCategory: function(categoryId){
                    console.log("Category selected:", categoryId);
                    this.selectedCategoryId = categoryId;
                    for(var i = 0 ; i < this.categories.length; i++){
                        var category = this.categories[i];
                        if(category.id === categoryId){
                            this.selectedCategory = null;
                            this.selectedCategory = category;
                            break;
                        }
                    }
                },
                openCreateModal: function(){
                    this.$.createModal.open();
                },
                createCategory: function(){
                    var self = this;
                    console.log("Creating category...");
                    var name = self.newCategoryName;
                    self.showMessage("Creating category: " + name);
                    this.$.ajax.adminCreateCategory(name).then(function(data){
                        var response = data.response;
                        console.log("Category created successfully:", response);
                        self.newCategoryName = "";
                        self.showSuccess("Category created: " + name);
                        self.$.createModal.close();
                        self.push('categories', response);
                    }, function(data){
                        console.log(data);
                        self.showError("Could not create category, check your input and try again.");
                    });
                },
                showError: function(message){
                    this.$.errorToast.text = message;
                    this.$.errorToast.open();
                },
                showMessage: function(message){
                    this.$.messageToast.text = message;
                    this.$.messageToast.open();
                },
                showSuccess: function(message){
                    this.$.successToast.text = message;
                    this.$.successToast.open();
                },
                _categorySelected: function(){
                    var self = this;
                    return function(evt){
                        var selected = evt.detail;
                        self.set('route.path', "/admin/categories/"+selected.id);
                    };
                },
                _viewingCanceled: function(){
                    this.set('route.path', "/admin/categories/all");
                },
                _fetchProducts: function(){
                    var self = this;
                    self.showMessage("Fetching products...");
                    this.$.ajax.adminGetProducts().then(function(data){
                        var products = data.response;
                        console.log("Products:", products);

                        var pushParams = ['products'];
                        for(var i = 0 ; i < products.length; i++){
                            var product = products[i];
                            pushParams.push(product);
                        }

                        self.splice("products", 0, self.products.length);
                        self.push.apply(self, pushParams);
                        self.showSuccess("Products fetched");
                    }, function(data){
                        console.log(data);
                        self.showError("Could not fetch products, please try again later.")
                    })
                },
                ready: function(){
                    this.$.messageToast.fitInto = this.$.container;
                    this.$.errorToast.fitInto = this.$.container;
                    this.$.successToast.fitInto = this.$.container;

                    this.$.categoriesList.addEventListener('selected-category', this._categorySelected());
                    this._fetchCategories().then(this._fetchProducts.bind(this));
                }
            });
        })();
    </script>
</dom-module>