<link rel="import" href="/bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/app-route/app-location.html">
<link rel="import" href="../bower_components/app-route/app-route.html">
<link rel="import" href="../bower_components/iron-pages/iron-pages.html">
<link rel="import" href="../bower_components/paper-fab/paper-fab.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/vaadin-grid/vaadin-grid.html">
<link rel="import" href="../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../bower_components/paper-toast/paper-toast.html">
<link rel="import" href="../bower_components/paper-input/paper-input.html">
<link rel="import" href="./km-ajax.html">

<dom-module id="km-admin-categories">
    <template>
        <style>
            :host{
                display: block;
                height: 100%;
            }
            #container {
                min-height: 100%;
            }
            #productsGrid {
                height: 100%;
            }
            #add-icon {
                position: fixed;
                bottom: 10px;
                right: 10px;
            }
            .primary {
                background-color: var(--primary-color, "blue");
                color: white;
            }
            .danger {
                background-color: var(--danger-color, "red");
                color: white;
            }
            .success {
                background-color: var(--success-color, "green");
                color: white;
            }
            iron-pages{
                min-height: 100%;
                background: white;
            }
            #createModal{
                width: 450px;
            }
        </style>
        <app-location route="{{route}}"></app-location>
        <app-route
                id="approute"
                route="{{route}}"
                pattern="/admin/categories/:page"
                data="{{routeData}}"
                tail="{{subroute}}">

        </app-route>

        <km-ajax id="ajax"></km-ajax>
        <div id="container">
            <iron-pages role="main" selected="[[page]]" attr-for-selected="name">
                <km-admin-categories-list id="categoriesList" name="all" categories="[[categories]]"></km-admin-categories-list>
                <km-admin-categories-view id="viewingCategory"
                                          name="view"
                                          on-viewing-canceled="_viewingCanceled"
                                          category="[[selectedCategory]]"
                                          products="[[products]]"
                                          category-products="[[categoryProducts]]"
                                          on-category-changed="_selectedChanged">

                </km-admin-categories-view>
            </iron-pages>


            <paper-fab class="primary" id="add-icon" icon="add" on-click="openCreateModal"></paper-fab>

            <paper-dialog id="createModal">
                <h2>Create Category</h2>
                <p>
                    <paper-input label="Category Name" value="{{newCategoryName}}"></paper-input>
                </p>
                <div class="buttons">
                    <paper-button dialog-confirm>Cancel</paper-button>
                    <paper-button class="primary" on-click="createCategory">Create</paper-button>
                </div>
            </paper-dialog>
        </div>
        <paper-toast class="success" id="successToast" class="fit-bottom" text=""></paper-toast>
        <paper-toast class="primary" id="messageToast" class="fit-bottom" text=""></paper-toast>
        <paper-toast class="danger" id="errorToast" class="fit-bottom" text=""></paper-toast>
    </template>
    <script>
        (function () {
            Polymer({
                is: 'km-admin-categories',
                properties: {
                    page: {
                        type: String,
                        reflectToAttribute: true,
                        observer: '_pageChanged'
                    },
                    categories: {
                        type: Array,
                        value: function(){
                            return [];
                        },
                        notify: true
                    },
                    newCategoryName: {
                        type: String,
                        value: ""
                    },
                    selectedCategoryId: {
                        type: Number,
                        value: 0
                    },
                    selectedCategory: {
                        type: Object,
                        value: function(){
                            return null;
                        }
                    },
                    products: {
                        type: Object,
                        value: function() {
                            return [];
                        }
                    },
                    categoryProducts: {
                        type: Array,
                        value: function(){
                            return [];
                        },
                        notify:true
                    }
                },
                observers: [
                    '_routePageChanged(routeData.page)',
                    '_setSelectedCategory(categories.splices)',
                    '_setSelectedCategory(categories)'
                ],
                _updateCategory: function(category){
                    var self = this;
                    self.showMessage("Saving changes to category: " + category.name);
                    return self.$.ajax.adminUpdateCategory(category).then(function(data){
                        delete category.product_ids;
                        console.log("Category updated");
                        self.showSuccess("Category " + category.name + " was updated.");
                        for(var i = 0; i < self.categories.length; i++){
                            var p = self.categories[i];
                            if(p.id === category.id){
                                self.splice("categories", i, 1, category);
                                break;
                            }
                        }

                        self.set('route.path', "/admin/categories/all");
                        var categories = self.categories;
                        self.categories = [];
                        self.categories = categories;
                    }, function(data){
                        delete delete category.product_ids;
                        console.log("Failed to update:", data);
                        self.showError("Failed to update the category, please refresh this page and try again later.");
                    });
                },
                _selectedChanged: function(evt){
                    var self = this;
                    console.log("Selected category changed:", evt.detail);
                    var category = evt.detail.category;
                    var products = evt.detail.products;
                    var productLookup = {};
                    var categoryProducts = {};
                    for(var i = 0 ; i < products.length; i++){
                        var product = products[i];
                        productLookup[""+product.id] = true;
                        categoryProducts[""+category.id] = ""+product.id;
                    }

                    var toRemove = [];
                    for(i=0 ; i < self.categoryProducts.length; i++){
                        var categoryProduct = self.categoryProducts[i];
                        if(categoryProduct.category_id === category.id && !productLookup[""+categoryProduct.product_id]) {
                            var cStr = ""+categoryProduct.category_id;
                            var pStr = ""+categoryProduct.product_id;
                            var p = {};
                            p[cStr] = pStr;
                            toRemove.push(p);
                        }
                    }

                    this._updateCategory(category).then(function(){
                        self.showMessage("Removing products...");
                        console.log("Removing products:", toRemove);
                        self.$.ajax.adminUnsetCategoryProducts(toRemove).then(function(evt){
                            self.showSuccess("Products removed.");
                            for(i=0 ; i < self.categoryProducts.length; i++){
                                var categoryProduct = self.categoryProducts[i];
                                if(categoryProduct.category_id === category.id && !productLookup[""+categoryProduct.product_id]) {
                                    console.log("Removing:", categoryProduct);
                                    self.splice('categoryProducts', i, 1);
                                    i--;
                                    delete productLookup[""+categoryProduct.product_id];
                                } else if(categoryProduct.category_id === category.id && productLookup[""+categoryProduct.product_id]){
                                    delete productLookup[""+categoryProduct.product_id];
                                }
                            }
                        }, function(evt){
                            console.log(evt);
                            self.showError("Failed to unset category products.");
                        }).then(function(evt){
                            var toAdd = [];
                            for (var productId in productLookup) {
                                if(!productLookup.hasOwnProperty(productId)){
                                    continue;
                                }
                                toAdd.push(category.id+":"+productId);
                            }

                            self.showMessage("Adding products...");
                            console.log("Adding products:", toAdd);
                            self.$.ajax.adminSetCategoryProducts({to_add: toAdd}).then(function(evt){
                                self.showSuccess("Products added.");
                                for (var productId in productLookup) {
                                    if(!productLookup.hasOwnProperty(productId)){
                                        continue;
                                    }
                                    var cp = {category_id: category.id, product_id: parseInt(productId)};
                                    console.log("Adding:", cp);
                                    self.push('categoryProducts', cp);
                                }
                            }, function(evt){
                                console.log(evt);
                                self.showError("Failed to set category products.");
                            });
                        });
                    });
                },
                _routePageChanged: function (page) {
                    switch(page){
                        case undefined:
                        case null:
                        case "":
                        case "all":
                            this.page = "all";
                            break;
                        default:
                            this.setSelectedCategory(parseInt(page));
                            this.page = "view";
                    }
                },
                _pageChanged: function (page) {
                    switch(page){
                        case "all":
                            page = "list";
                            break;
                        default:
                            page = "view"
                    }
                    this.importHref(this.resolveUrl("km-admin-categories-" + page + '.html'), null, null, true);
                },
                _setSelectedCategory: function(){
                    this.setSelectedCategory(this.selectedCategoryId);
                },
                setSelectedCategory: function(categoryId){
                    if(!categoryId){
                        return;
                    }

                    this.selectedCategoryId = categoryId;
                    for(var i = 0 ; i < this.categories.length; i++){
                        var category = this.categories[i];
                        if(category.id === categoryId){
                            this.selectedCategory = null;
                            this.selectedCategory = category;
                            break;
                        }
                    }
                },
                openCreateModal: function(){
                    this.$.createModal.open();
                },
                createCategory: function(){
                    var self = this;
                    console.log("Creating category...");
                    var name = self.newCategoryName;
                    self.showMessage("Creating category: " + name);
                    this.$.ajax.adminCreateCategory(name).then(function(data){
                        var response = data.response;
                        console.log("Category created successfully:", response);
                        self.newCategoryName = "";
                        self.showSuccess("Category created: " + name);
                        self.$.createModal.close();
                        self.push('categories', response);
                    }, function(data){
                        console.log(data);
                        self.showError("Could not create category, check your input and try again.");
                    });
                },
                showError: function(message){
                    this.$.errorToast.text = message;
                    this.$.errorToast.open();
                },
                showMessage: function(message){
                    this.$.messageToast.text = message;
                    this.$.messageToast.open();
                },
                showSuccess: function(message){
                    this.$.successToast.text = message;
                    this.$.successToast.open();
                },
                _categorySelected: function(){
                    var self = this;
                    return function(evt){
                        var selected = evt.detail;
                        self.set('route.path', "/admin/categories/"+selected.id);
                    };
                },
                _viewingCanceled: function(){
                    this.set('route.path', "/admin/categories/all");
                },
                ready: function(){
                    this.$.messageToast.fitInto = this.$.container;
                    this.$.errorToast.fitInto = this.$.container;
                    this.$.successToast.fitInto = this.$.container;

                    this.$.categoriesList.addEventListener('selected-category', this._categorySelected());
                }
            });
        })();
    </script>
</dom-module>